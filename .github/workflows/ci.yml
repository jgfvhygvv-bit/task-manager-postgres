name: Fast CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 10  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine  # –ë–æ–ª–µ–µ –ª–µ–≥–∫–∏–π –æ–±—Ä–∞–∑
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 5s  # –£–º–µ–Ω—å—à–µ–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏
          --health-timeout 3s
          --health-retries 3
        ports:
          - 5432:5432
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v3
    
    - name: ‚ö° –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'  # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ pip –ø–∞–∫–µ—Ç–æ–≤
    
    - name: üì¶ –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        python -m pip install --upgrade pip
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
        if [ -f requirements-dev.txt ]; then
          pip install -r requirements-dev.txt
        elif [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        pip install pytest pytest-cov flake8 sqlalchemy psycopg2-binary
    
    - name: üîç –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
      run: |
        echo "üîç –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –µ—Å–ª–∏ —ç—Ç–æ PR
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ PR..."
          # –ù–∞—Ö–æ–¥–∏–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ .py —Ñ–∞–π–ª—ã
          changed_files=$(git diff --name-only origin/${{ github.base_ref }} | grep '\.py$' || true)
          if [ -n "$changed_files" ]; then
            echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —Ñ–∞–π–ª—ã:"
            echo "$changed_files"
            python -m py_compile $changed_files
          else
            echo "‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö Python —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"
          fi
        else
          # –î–ª—è push –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ
          find . -name "*.py" -type f | head -20 | xargs python -m py_compile || true
        fi
        
        echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å Python OK"
        
        echo "üîç –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è (—Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏)..."
        # –¢–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ flake8
        flake8 app/ tests/ --select=E9,F63,F7,F82 --count --quiet || true
        echo "‚úÖ –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    - name: üß™ –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
      env:
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_DB: testdb
        SECRET_KEY: test-secret-key
        SQLALCHEMY_DATABASE_URI: postgresql://postgres:postgres@localhost:5432/testdb
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ –±—ã—Å—Ç—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã –±–µ–∑ –ø–æ–∫—Ä—ã—Ç–∏—è –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "üöÄ –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è PR..."
          python -m pytest tests/ -v --tb=short -k "not slow and not integration" || python -m pytest tests/ -v --tb=short
        else
          echo "üöÄ –ü–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è main –≤–µ—Ç–∫–∏..."
          python -m pytest tests/ -v --cov=app --cov-report=xml --tb=short
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏
          coverage=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(float(root.attrib['line-rate']) * 100)")
          echo "üìä –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞: ${coverage}%"
          
          if (( $(echo "$coverage < 50" | bc -l) )); then
            echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ –Ω–∏–∂–µ 50%"
          fi
        fi
    
    - name: üöÄ –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞
      env:
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_DB: testdb
      run: |
        echo "üöÄ –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
        # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∞
        python << 'EOF'
import sys
sys.path.insert(0, '.')
try:
    from app import create_app
    app = create_app('testing')
    print('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ')
    
    # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    required_configs = ['SECRET_KEY', 'SQLALCHEMY_DATABASE_URI']
    for config in required_configs:
        if config in app.config:
            print(f'‚úÖ –ö–æ–Ω—Ñ–∏–≥ {config}: OK')
        else:
            print(f'‚ö†Ô∏è –ö–æ–Ω—Ñ–∏–≥ {config}: –Ω–µ –Ω–∞–π–¥–µ–Ω')
            
except Exception as e:
    print(f'‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: {e}')
    sys.exit(1)
EOF
    
    - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
      if: github.event_name != 'pull_request'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
    
    - name: üìã –ë—ã—Å—Ç—Ä—ã–π –æ—Ç—á–µ—Ç
      run: |
        echo "========================================"
        echo "‚ö° –ë—ã—Å—Ç—Ä—ã–π CI/CD Pipeline - –í–´–ü–û–õ–ù–ï–ù–û!"
        echo "========================================"
        echo "‚åõ –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ"
        echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:"
        echo "  - ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL –≥–æ—Ç–æ–≤–∞"
        echo "  - ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å Python –ø—Ä–æ–≤–µ—Ä–µ–Ω"
        echo "  - ‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
        echo "  - ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è"
        echo "========================================"